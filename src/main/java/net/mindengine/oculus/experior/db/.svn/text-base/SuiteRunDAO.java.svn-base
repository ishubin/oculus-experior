package net.mind_engine.oculus.testrunframework.db;

import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.Timestamp;
import java.util.Date;

import org.apache.commons.logging.Log;
import org.apache.commons.logging.LogFactory;


public class SuiteRunDAO extends SimpleDAO
{
	private Log logger = LogFactory.getLog(getClass());
	protected SuiteRunDAO(OculusSimpleJdbcDaoSupport daoSupport)
	{
		super(daoSupport);
	}
	
	public void updateSuiteEndTime(Long id, Date date) throws Exception
	{
		daoSupport.update("update suite_runs set end_time = :date where id = :id", 
				"id", id,
				"date", date);
	}
	public Long create(SuiteRunBean suite) throws Exception
	{
		PreparedStatement ps = daoSupport.getSQLConnection().prepareStatement(
				"insert into suite_runs (start_time, end_time, name, runner_id, parameters, agent_name) " +
				"values (?,?,?,?,?,?)");
		
		ps.setTimestamp(1, new Timestamp(suite.getStartTime().getTime()));
		ps.setTimestamp(2, new Timestamp(suite.getEndTime().getTime()));
		ps.setString(3, suite.getName());
		if(suite.getRunnerId()==null)suite.setRunnerId(0L);
		ps.setLong(4, suite.getRunnerId());
		ps.setString(5, suite.getSerializedParameters());
		String agentName = suite.getAgentName();
		if(agentName==null) agentName = "";
		ps.setString(6, agentName);
	
		logger.info(ps);
		ps.execute();
		
		ResultSet rs = ps.getGeneratedKeys();
		if(rs.next())
		{
			return rs.getLong(1);
		}
		return null;
	}
}
