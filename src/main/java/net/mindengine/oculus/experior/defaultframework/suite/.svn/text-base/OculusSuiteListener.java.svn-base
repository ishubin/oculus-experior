package net.mind_engine.oculus.simpletestframework.suite;

import java.util.Date;
import java.util.Map;

import net.mind_engine.oculus.testrunframework.db.OculusSimpleJdbcDaoSupport;
import net.mind_engine.oculus.testrunframework.db.TestRunBean;
import net.mind_engine.oculus.testrunframework.suite.Suite;
import net.mind_engine.oculus.testrunframework.suite.SuiteListener;

import org.apache.commons.lang.StringEscapeUtils;


/**
 * This class handles the suite data and writes it to the DB
 * @author Ivan Shubin
 *
 */
public class OculusSuiteListener implements SuiteListener
{

    @Override
    public void onSuiteStarted(Suite suite)
    {
    	OculusSimpleJdbcDaoSupport daoSupport = OculusSimpleJdbcDaoSupport.getInstance();
    	
    	/*
    	 * Converting the suite parameters to string with the following template:
    	 * <p><n>parameterName<v>parameterValue
    	 */
    	Map<String,String> parameters = suite.getParameters();
    	
    	StringBuffer serializedParameters = new StringBuffer();
    	for(Map.Entry<String, String> parameter :parameters.entrySet())
    	{
    	    serializedParameters.append("<p>");
    	    serializedParameters.append(StringEscapeUtils.escapeXml(parameter.getKey()));
    	    serializedParameters.append("<v>");
    	    serializedParameters.append(StringEscapeUtils.escapeXml(parameter.getValue()));
    	    serializedParameters.append("<p>");
    	}
    	suite.setSerializedParameters(serializedParameters.toString());
    	try
    	{
    	    Long id = daoSupport.getSuiteRunDAO().create(suite);
    	    suite.setId(id);
    	}
    	catch (Exception e) {
            throw new RuntimeException(e);
        }
    	
    }
    
    @Override
    public void onSuiteFinished(Suite suite)
    {
        OculusSimpleJdbcDaoSupport daoSupport = OculusSimpleJdbcDaoSupport.getInstance();
        try
        {
            daoSupport.getSuiteRunDAO().updateSuiteEndTime(suite.getId(), new Date());
        }
        catch (Exception e) {
            throw new RuntimeException(e);
        }
        
        if(suite.getTestRuns()!=null){
        	System.out.println("\n\n============================================================");
        	System.out.println("Total test runs: "+suite.getTestRuns().size());
        	System.out.println("------------------------------------------------------------");
        	int passed = 0;
        	int failed = 0;
        	int warning = 0;
        	
        	
        	for(TestRunBean testRun : suite.getTestRuns()){
        		if(testRun.getStatus().equals("PASSED")){
        			passed++;
        		}
        		else if(testRun.getStatus().equals("FAILED")){
        			failed++;
        		}
        		else if(testRun.getStatus().equals("Warning")){
        			warning++;
        		}
        	}
        	
        	System.out.println("Passed:  "+passed);
        	System.out.println("Failed:  "+failed);
        	System.out.println("Warning: "+warning);
        	System.out.println("============================================================");
        }
    }
}
